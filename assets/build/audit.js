(()=>{"use strict";const s=window.wp.element,e=window.wp.i18n,a=window.wp.components,t=window.ReactJSXRuntime,l=function({stats:s}){return(0,t.jsx)(a.Card,{className:"salt-shaker-stats-card",children:(0,t.jsx)(a.CardBody,{children:(0,t.jsxs)("div",{className:"salt-shaker-stats-grid",children:[(0,t.jsxs)("div",{className:"salt-shaker-stat",children:[(0,t.jsx)("div",{className:"stat-label",children:(0,e.__)("Total Rotations","salt-shaker")}),(0,t.jsx)("div",{className:"stat-value",children:s.total_rotations})]}),(0,t.jsxs)("div",{className:"salt-shaker-stat",children:[(0,t.jsx)("div",{className:"stat-label",children:(0,e.__)("Success Rate","salt-shaker")}),(0,t.jsxs)("div",{className:"stat-value",children:[s.success_rate,"%"]})]}),(0,t.jsxs)("div",{className:"salt-shaker-stat",children:[(0,t.jsx)("div",{className:"stat-label",children:(0,e.__)("Failed (30 days)","salt-shaker")}),(0,t.jsx)("div",{className:"stat-value stat-failed",children:s.failed_30_days})]}),(0,t.jsxs)("div",{className:"salt-shaker-stat",children:[(0,t.jsx)("div",{className:"stat-label",children:(0,e.__)("Avg Duration","salt-shaker")}),(0,t.jsx)("div",{className:"stat-value",children:(l=s.avg_duration_ms,l<1e3?`${l}ms`:`${(l/1e3).toFixed(2)}s`)})]}),(0,t.jsxs)("div",{className:"salt-shaker-stat",children:[(0,t.jsx)("div",{className:"stat-label",children:(0,e.__)("Last Rotation","salt-shaker")}),(0,t.jsx)("div",{className:"stat-value",children:(s=>{if(!s||!s.rotation_time)return(0,e.__)("Never","salt-shaker");const a=new Date(s.rotation_time.replace(" ","T")),t=new Date-a,l=Math.floor(t/864e5);if(0===l){const s=Math.floor(t/36e5);return 0===s?Math.floor(t/6e4)+" "+(0,e.__)("minutes ago","salt-shaker"):s+" "+(0,e.__)("hours ago","salt-shaker")}return 1===l?(0,e.__)("1 day ago","salt-shaker"):l+" "+(0,e.__)("days ago","salt-shaker")})(s.last_rotation)})]})]})})});var l},r=function({logs:l,page:r,totalPages:n,onPageChange:i}){const[d,o]=(0,s.useState)(null),[h,c]=(0,s.useState)(!1),_=s=>new Date(s.replace(" ","T")).toLocaleString(),u=s=>{const a=`status-badge status-${s}`,l="success"===s?"✓":"✗",r="success"===s?(0,e.__)("Success","salt-shaker"):(0,e.__)("Failed","salt-shaker");return(0,t.jsxs)("span",{className:a,children:[l," ",r]})},x=s=>({manual:(0,e.__)("Manual","salt-shaker"),scheduled:(0,e.__)("Scheduled","salt-shaker"),cli:(0,e.__)("CLI","salt-shaker"),api:(0,e.__)("API","salt-shaker")}[s]||s),k=()=>{c(!1),o(null)},j=s=>{navigator.clipboard.writeText(s).then((()=>{}))};return(0,t.jsxs)("div",{className:"salt-shaker-log-table-container",children:[0===l.length?(0,t.jsx)("div",{className:"salt-shaker-no-logs",children:(0,t.jsx)("p",{children:(0,e.__)("No audit logs found matching your filters.","salt-shaker")})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("table",{className:"salt-shaker-log-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:(0,e.__)("Date & Time","salt-shaker")}),(0,t.jsx)("th",{children:(0,e.__)("Triggered By","salt-shaker")}),(0,t.jsx)("th",{children:(0,e.__)("Method","salt-shaker")}),(0,t.jsx)("th",{children:(0,e.__)("Status","salt-shaker")}),(0,t.jsx)("th",{children:(0,e.__)("Duration","salt-shaker")}),(0,t.jsx)("th",{children:(0,e.__)("Actions","salt-shaker")})]})}),(0,t.jsx)("tbody",{children:l.map((s=>(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:_(s.rotation_time)}),(0,t.jsx)("td",{children:s.trigger_username}),(0,t.jsx)("td",{children:x(s.trigger_method)}),(0,t.jsx)("td",{children:u(s.status)}),(0,t.jsxs)("td",{children:[s.duration_ms,"ms"]}),(0,t.jsx)("td",{children:(0,t.jsx)(a.Button,{variant:"link",onClick:()=>(s=>{o(s),c(!0)})(s),children:(0,e.__)("View","salt-shaker")})})]},s.id)))})]}),n>1&&(0,t.jsxs)("div",{className:"salt-shaker-pagination",children:[(0,t.jsx)(a.Button,{variant:"secondary",disabled:1===r,onClick:()=>i(r-1),children:(0,e.__)("Previous","salt-shaker")}),(0,t.jsx)("span",{className:"pagination-info",children:(0,e.sprintf)((0,e.__)("Page %d of %d","salt-shaker"),r,n)}),(0,t.jsx)(a.Button,{variant:"secondary",disabled:r===n,onClick:()=>i(r+1),children:(0,e.__)("Next","salt-shaker")})]})]}),h&&d&&(0,t.jsxs)(a.Modal,{title:(0,e.__)("Rotation Details","salt-shaker"),onRequestClose:k,className:"salt-shaker-detail-modal",children:[(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("Status","salt-shaker")}),u(d.status)]}),(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("Timing","salt-shaker")}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Rotation Time:","salt-shaker")})," ",_(d.rotation_time)]}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Duration:","salt-shaker")})," ",d.duration_ms," ",(0,e.__)("milliseconds","salt-shaker")]})]}),(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("Triggered By","salt-shaker")}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("User:","salt-shaker")})," ",d.trigger_username,d.triggered_by>0&&` (ID: ${d.triggered_by})`]}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Method:","salt-shaker")})," ",x(d.trigger_method)]}),d.ip_address&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("IP Address:","salt-shaker")})," ",d.ip_address]}),d.user_agent&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("User Agent:","salt-shaker")})," ",d.user_agent]})]}),(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("Impact","salt-shaker")}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Active Sessions Terminated:","salt-shaker")})," ",d.affected_users," ",(0,e.__)("users","salt-shaker")]}),(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Salt Source:","salt-shaker")})," ","wordpress_api"===d.salt_source?(0,e.__)("WordPress.org API","salt-shaker"):(0,e.__)("Local Generation","salt-shaker")]}),d.config_file_path&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Config File:","salt-shaker")})," ",(0,t.jsx)("code",{children:d.config_file_path})]})]}),(d.old_salt_hash||d.new_salt_hash)&&(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("Salt Verification Hashes","salt-shaker")}),d.old_salt_hash&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Previous:","salt-shaker")})," ",(0,t.jsxs)("code",{children:[d.old_salt_hash.substring(0,20),"..."]}),(0,t.jsx)(a.Button,{variant:"link",onClick:()=>j(d.old_salt_hash),children:(0,e.__)("Copy","salt-shaker")})]}),d.new_salt_hash&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Current:","salt-shaker")})," ",(0,t.jsxs)("code",{children:[d.new_salt_hash.substring(0,20),"..."]}),(0,t.jsx)(a.Button,{variant:"link",onClick:()=>j(d.new_salt_hash),children:(0,e.__)("Copy","salt-shaker")})]})]}),(0,t.jsxs)("div",{className:"detail-section",children:[(0,t.jsx)("h3",{children:(0,e.__)("System Information","salt-shaker")}),d.wp_version&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("WordPress Version:","salt-shaker")})," ",d.wp_version]}),d.plugin_version&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Plugin Version:","salt-shaker")})," ",d.plugin_version]}),d.schedule_interval&&(0,t.jsxs)("p",{children:[(0,t.jsx)("strong",{children:(0,e.__)("Schedule:","salt-shaker")})," ",d.schedule_interval]})]}),d.error_message&&(0,t.jsxs)("div",{className:"detail-section detail-error",children:[(0,t.jsx)("h3",{children:(0,e.__)("Error Message","salt-shaker")}),(0,t.jsx)("p",{className:"error-message",children:d.error_message})]}),(0,t.jsx)("div",{className:"modal-actions",children:(0,t.jsx)(a.Button,{variant:"primary",onClick:k,children:(0,e.__)("Close","salt-shaker")})})]})]})},n=function({filters:s,onFilterChange:l}){const r=(e,a)=>{l({...s,[e]:a})};return(0,t.jsxs)("div",{className:"salt-shaker-filters",children:[(0,t.jsx)(a.SelectControl,{label:(0,e.__)("Status","salt-shaker"),value:s.status,options:[{label:(0,e.__)("All Statuses","salt-shaker"),value:""},{label:(0,e.__)("Success","salt-shaker"),value:"success"},{label:(0,e.__)("Failed","salt-shaker"),value:"failed"}],onChange:s=>r("status",s)}),(0,t.jsx)(a.SelectControl,{label:(0,e.__)("Method","salt-shaker"),value:s.method,options:[{label:(0,e.__)("All Methods","salt-shaker"),value:""},{label:(0,e.__)("Manual","salt-shaker"),value:"manual"},{label:(0,e.__)("Scheduled","salt-shaker"),value:"scheduled"},{label:(0,e.__)("CLI","salt-shaker"),value:"cli"},{label:(0,e.__)("API","salt-shaker"),value:"api"}],onChange:s=>r("method",s)}),(0,t.jsx)(a.Button,{variant:"secondary",onClick:()=>{l({status:"",method:"",user_id:""})},children:(0,e.__)("Reset Filters","salt-shaker")})]})},i=function({onSettingsSaved:l}){const[r,n]=(0,s.useState)(90),[i,d]=(0,s.useState)(180),[o,h]=(0,s.useState)(!0),[c,_]=(0,s.useState)(!1),[u,x]=(0,s.useState)(!1),[k,j]=(0,s.useState)(null);return(0,t.jsxs)(a.Card,{children:[(0,t.jsx)(a.CardHeader,{children:(0,t.jsx)("h2",{children:(0,e.__)("Audit Log Settings","salt-shaker")})}),(0,t.jsxs)(a.CardBody,{children:[k&&(0,t.jsx)(a.Notice,{status:k.type,isDismissible:!0,onRemove:()=>j(null),children:k.text}),(0,t.jsx)("div",{className:"salt-shaker-settings-row",children:(0,t.jsx)(a.TextControl,{label:(0,e.__)("Data Retention (days)","salt-shaker"),help:(0,e.__)("Keep successful rotation logs for this many days (1-365)","salt-shaker"),type:"number",min:"1",max:"365",value:r,onChange:s=>n(parseInt(s)||90)})}),(0,t.jsx)("div",{className:"salt-shaker-settings-row",children:(0,t.jsx)(a.TextControl,{label:(0,e.__)("Failed Rotation Retention (days)","salt-shaker"),help:(0,e.__)("Keep failed rotation logs for this many days (1-730)","salt-shaker"),type:"number",min:"1",max:"730",value:i,onChange:s=>d(parseInt(s)||180)})}),(0,t.jsx)("div",{className:"salt-shaker-settings-row",children:(0,t.jsx)(a.ToggleControl,{label:(0,e.__)("Auto Cleanup Enabled","salt-shaker"),help:(0,e.__)("Automatically clean up old logs daily","salt-shaker"),checked:o,onChange:h})}),(0,t.jsxs)("div",{className:"salt-shaker-settings-actions",children:[(0,t.jsx)(a.Button,{variant:"primary",onClick:()=>{_(!0),j(null),fetch(saltShakerAuditData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salt_shaker_save_audit_settings",nonce:saltShakerAuditData.nonce,retention_days:r,failed_retention_days:i,auto_cleanup_enabled:o})}).then((s=>s.json())).then((s=>{s.success?(j({type:"success",text:s.data.message}),l&&l()):j({type:"error",text:s.data||(0,e.__)("Failed to save settings","salt-shaker")})})).catch((s=>{j({type:"error",text:(0,e.__)("Network error while saving settings","salt-shaker")}),console.error("Error saving settings:",s)})).finally((()=>{_(!1)}))},isBusy:c,disabled:c,children:c?(0,e.__)("Saving...","salt-shaker"):(0,e.__)("Save Settings","salt-shaker")}),(0,t.jsx)(a.Button,{variant:"secondary",onClick:()=>{confirm((0,e.__)("Are you sure you want to clean up old logs now?","salt-shaker"))&&(x(!0),j(null),fetch(saltShakerAuditData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salt_shaker_cleanup_audit_logs",nonce:saltShakerAuditData.nonce})}).then((s=>s.json())).then((s=>{s.success?(j({type:"success",text:s.data.message}),l&&l()):j({type:"error",text:s.data||(0,e.__)("Failed to cleanup logs","salt-shaker")})})).catch((s=>{j({type:"error",text:(0,e.__)("Network error while cleaning up logs","salt-shaker")}),console.error("Error cleaning up logs:",s)})).finally((()=>{x(!1)})))},isBusy:u,disabled:u,children:u?(0,e.__)("Cleaning...","salt-shaker"):(0,e.__)("Cleanup Old Logs Now","salt-shaker")})]})]})]})};function d(){const[d,o]=(0,s.useState)([]),[h,c]=(0,s.useState)(null),[_,u]=(0,s.useState)(!0),[x,k]=(0,s.useState)(null),[j,g]=(0,s.useState)(1),[m,p]=(0,s.useState)(1),[v,S]=(0,s.useState)({status:"",method:"",user_id:""}),y=()=>{fetch(saltShakerAuditData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salt_shaker_get_audit_stats",nonce:saltShakerAuditData.nonce})}).then((s=>s.json())).then((s=>{s.success&&c(s.data)})).catch((s=>{console.error("Error fetching stats:",s)}))};(0,s.useEffect)((()=>{y(),u(!0),k(null),fetch(saltShakerAuditData.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salt_shaker_get_audit_logs",nonce:saltShakerAuditData.nonce,page:j,per_page:20,...v})}).then((s=>s.json())).then((s=>{s.success?(o(s.data.logs),p(s.data.total_pages)):k(s.data||(0,e.__)("Failed to load audit logs","salt-shaker"))})).catch((s=>{k((0,e.__)("Network error while loading audit logs","salt-shaker")),console.error("Error fetching logs:",s)})).finally((()=>{u(!1)}))}),[j,v]);const f=s=>{const e=new URLSearchParams({action:"salt_shaker_export_audit_logs",nonce:saltShakerAuditData.nonce,format:s,...v}),a=document.createElement("form");a.method="POST",a.action=saltShakerAuditData.ajaxUrl,a.style.display="none",e.forEach(((s,e)=>{const t=document.createElement("input");t.name=e,t.value=s,a.appendChild(t)})),document.body.appendChild(a),a.submit(),document.body.removeChild(a)};return(0,t.jsxs)("div",{className:"salt-shaker-audit-log",children:[(0,t.jsxs)("div",{className:"salt-shaker-audit-header",children:[(0,t.jsx)("h1",{children:(0,e.__)("Salt Shaker - Audit Log","salt-shaker")}),(0,t.jsxs)("div",{className:"salt-shaker-audit-actions",children:[(0,t.jsx)(a.Button,{variant:"secondary",onClick:()=>f("csv"),children:(0,e.__)("Export CSV","salt-shaker")}),(0,t.jsx)(a.Button,{variant:"secondary",onClick:()=>f("json"),children:(0,e.__)("Export JSON","salt-shaker")})]})]}),x&&(0,t.jsx)(a.Notice,{status:"error",isDismissible:!1,children:x}),h&&(0,t.jsx)(l,{stats:h}),(0,t.jsx)(a.__experimentalDivider,{}),(0,t.jsxs)(a.Card,{children:[(0,t.jsx)(a.CardHeader,{children:(0,t.jsx)("h2",{children:(0,e.__)("Rotation History","salt-shaker")})}),(0,t.jsxs)(a.CardBody,{children:[(0,t.jsx)(n,{filters:v,onFilterChange:s=>{S(s),g(1)}}),_?(0,t.jsxs)("div",{className:"salt-shaker-loading",children:[(0,t.jsx)(a.Spinner,{}),(0,t.jsx)("p",{children:(0,e.__)("Loading audit logs...","salt-shaker")})]}):(0,t.jsx)(r,{logs:d,page:j,totalPages:m,onPageChange:g})]})]}),(0,t.jsx)(a.__experimentalDivider,{}),(0,t.jsx)(i,{onSettingsSaved:y})]})}window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("salt-shaker-audit-log");if(e)try{(0,s.createRoot)(e).render((0,t.jsx)(s.StrictMode,{children:(0,t.jsx)(d,{})}))}catch(s){console.error("Failed to render Salt Shaker audit log:",s)}}))})();